{% extends "admin/index.html" %}
{% load static %}
{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/admin.css' %}">
{% endblock %}
{% block content %}
<div class="dashboard">
    <div class="mt-6 flex gap-4">
    <a href="{% url 'export_excel' %}" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
        –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
    </a>
</div>
    <!-- –ë–ª–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- –¢–µ—Å—Ç—ã -->
        <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">
            <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200">–¢–µ—Å—Ç—ã</h3>
            <div class="text-2xl dark:text-white">{{ test_stats.total }}</div>
            <div class="text-green-600 dark:text-green-400">{{ test_stats.passed }} –ø—Ä–æ–π–¥–µ–Ω–æ</div>
            <div class="text-red-600 dark:text-red-400">{{ test_stats.failed }} –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ</div>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏ -->
        <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">
            <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200">–ò–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏</h3>
            <div class="text-2xl dark:text-white">{{ instruction_stats.total }}</div>
            <div class="text-green-600 dark:text-green-400">{{ instruction_stats.passed }} –ø—Ä–æ–π–¥–µ–Ω–æ</div>
            <div class="text-red-600 dark:text-red-400">{{ instruction_stats.failed }} –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–æ</div>
        </div>

        <!-- –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª -->
<!--        <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">-->
<!--            <h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-200">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</h3>-->
<!--            <div class="text-2xl dark:text-white">{{ test_stats.avg_score|floatformat:1 }}</div>-->
<!--        </div>-->
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Å–ø–∏—Å–∫–∏ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- –ì—Ä–∞—Ñ–∏–∫ —Ç–µ—Å—Ç–æ–≤ -->
        <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">
            <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h3>
            <canvas id="testResultsChart"></canvas>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π -->
        <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">
            <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π</h3>
            <canvas id="instructionResultsChart"></canvas>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–≤–∞–ª—ã -->
        <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur col-span-2">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã</h3>
                    <ul class="space-y-3">
                        {% for result in recent_failed_tests %}
                        <li class="flex items-center justify-between p-3 bg-red-100 dark:bg-red-900/20 rounded">
                            <span class="dark:text-gray-300">{{ result.user }}</span>
                            <span class="dark:text-gray-400">{{ result.test }}</span>
                            <span class="text-sm dark:text-gray-500">{{ result.completion_time|date:"d.m.Y" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏</h3>
                    <ul class="space-y-3">
                        {% for result in recent_failed_instructions %}
                        <li class="flex items-center justify-between p-3 bg-red-100 dark:bg-red-900/20 rounded">
                            <span class="dark:text-gray-300">{{ result.user }}</span>
                            <span class="dark:text-gray-400">{{ result.instruction }}</span>
                            <span class="text-sm dark:text-gray-500">{{ result.date|date:"d.m.Y" }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <!-- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
    <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">
        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
        <div class="space-y-3">
            {% for question in problematic_questions %}
            <div class="flex items-center justify-between p-3 bg-orange-100 dark:bg-orange-900/20 rounded">
                <div class="flex-1 truncate">
                    <span class="dark:text-gray-300">{{ question.question__name|truncatechars:40 }}</span>
                    <span class="text-sm dark:text-gray-500 ml-2">(ID: {{ question.question_id }})</span>
                </div>
                <span class="text-red-600 dark:text-red-400 ml-2">{{ question.total_errors }} –æ—à–∏–±–æ–∫</span>
            </div>
            {% empty %}
            <div class="p-3 text-gray-500 dark:text-gray-400">
                –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –°–ª–∞–±–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ -->
    <div class="bg-opacity-10 bg-gray-500 p-6 rounded-lg shadow backdrop-blur">
        <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</h3>
        <div class="space-y-3">
            {% for user in weak_users %}
            <div class="flex items-center justify-between p-3 bg-purple-100 dark:bg-purple-900/20 rounded">
                <span class="dark:text-gray-300">{{ user.user_name }}</span>
                <div class="flex gap-2">
                    <span class="text-red-600 dark:text-red-400" title="–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã">
                        {{ user.test_fails }} ‚ö†Ô∏è
                    </span>
                    <span class="text-yellow-600 dark:text-yellow-400" title="–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–∏">
                        {{ user.instruction_fails }} üìã
                    </span>
                </div>
            </div>
            {% empty %}
            <div class="p-3 text-gray-500 dark:text-gray-400">
                –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
            </div>
            {% endfor %}
        </div>
    </div>
</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤
const getChartColors = () => {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  return {
    text: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim(),
    border: getComputedStyle(document.documentElement).getPropertyValue('--chart-border').trim(),
    testPassed: getComputedStyle(document.documentElement).getPropertyValue('--test-passed').trim(),
    testFailed: getComputedStyle(document.documentElement).getPropertyValue('--test-failed').trim(),
    instructionPassed: getComputedStyle(document.documentElement).getPropertyValue('--instruction-passed').trim(),
    instructionFailed: getComputedStyle(document.documentElement).getPropertyValue('--instruction-failed').trim(),
  }
};

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
let testChart, instructionChart;

const updateChartsTheme = () => {
  const colors = getChartColors();

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
  testChart.data.datasets[0].backgroundColor = [colors.testPassed, colors.testFailed];
  testChart.options.plugins.legend.labels.color = colors.text;
  testChart.update();

  // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π
  instructionChart.data.datasets[0].backgroundColor = [colors.instructionPassed, colors.instructionFailed];
  instructionChart.options.plugins.legend.labels.color = colors.text;
  instructionChart.update();
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', () => {
  const colors = getChartColors();

  // –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Chart.js
  Chart.defaults.color = colors.text;
  Chart.defaults.borderColor = colors.border;

  // –¢–µ—Å—Ç–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
  testChart = new Chart(document.getElementById('testResultsChart'), {
    type: 'doughnut',
    data: {
      labels: ['–ü—Ä–æ–π–¥–µ–Ω–æ', '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ'],
      datasets: [{
        data: [{{ test_stats.passed }}, {{ test_stats.failed }}],
        backgroundColor: [colors.testPassed, colors.testFailed],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            color: colors.text
          }
        }
      }
    }
  });

  // –ì—Ä–∞—Ñ–∏–∫ –∏–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂–µ–π
  instructionChart = new Chart(document.getElementById('instructionResultsChart'), {
    type: 'doughnut',
    data: {
      labels: ['–ü—Ä–æ–π–¥–µ–Ω–æ', '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ'],
      datasets: [{
        data: [{{ instruction_stats.passed }}, {{ instruction_stats.failed }}],
        backgroundColor: [colors.instructionPassed, colors.instructionFailed],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            color: colors.text
          }
        }
      }
    }
  });

  // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
  const observer = new MutationObserver(mutations => {
    mutations.forEach(mutation => {
      if (mutation.attributeName === 'data-theme') {
        updateChartsTheme();
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true
  });
});
</script>
{% endblock %}